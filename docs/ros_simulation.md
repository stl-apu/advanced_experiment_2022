# シミュレーション
- シミュレーターの中でロボットを動作させます。
- turtlesimをキーボードで動かします。  

## 準備
- シミュレーション用のROSパッケージをインストールする。
  ```
  $ sudo apt update
  $ sudo apt -y install ros-melodic-turtlesim
  ```

## 基礎
- 全部で3つのターミナルを用います。ターミナルを3つ用意しても良いですし、1つのターミナルに3つのタブを作成しても良いです。
- 3つ目のターミナルをアクティブにした状態で矢印キー（↑キーや→キー）を入力すると、ロボットを動かせます。
- ROSマスターやROSノードは「Ctrlキー＋cキー」で停止できます。

### 1つ目：ROSマスターの起動
- 環境変数などを設定する。
  ```
  $ source ~/catkin_ws/devel/setup.bash
  ```
- ROSマスターを起動する。  
  ```
  $ roscore
  ```

### 2つ目：シミュレーターの起動
- 環境変数などを設定する。
  ```
  $ source ~/catkin_ws/devel/setup.bash
  ```
- バーチャルなロボットとして、turtlesimノードを起動する。  
  ```
  $ rosrun turtlesim turtlesim_node
  ```

### 3つ目：コントローラーの起動
- 環境変数などを設定する。
  ```
  $ source ~/catkin_ws/devel/setup.bash
  ```
- ロボットを動かすため、キーボード入力を速度情報に変換するROSノードを起動する。
  ```
  $ rosrun turtlesim turtle_teleop_key
  ```
- 重要なポイントは、/teleop_turtleノードは速度情報を出版しているだけ、/turtlesimノードは速度情報を購読しているだけで、どのノードが配信・購読しているかは全く関係ないところです。つまり、速度情報（/turtle1/cmd_vel）を出すのが、キーボードでも、マウスでも、ジョイスティックでも、画像処理の結果でも、音声処理の結果でも、何でも大丈夫です。同様に、キーボードだけで、バーチャルなロボットも、リアルなロボットも、自動車も、ドローンも、何でも操作することができます。
- これがROSの利点です！

## 発展

### 4つ目：グローバル変数の利用
- ROSマスターが起動すると、ROSパラメーターサーバーも一緒に起動します。
- このサーバーを介して、グローバル変数のように全てのノードで利用可能な変数を共有することができます。

- どんなROSパラメーターがあるかを確認する。
  ```
  $ rosparam list
  ```
- 具体的な値を確認する。
  ```
  $ rosparam get /turtlesim/background_b
  ```
- 値を変更する。
  ```
  $ rosparam set /turtlesim/background_b 0
  ```  
- パラメーターはノードを生成した時に読み込まれるため、強制的に再読み込みを行い、変更内容を反映する。  
  ```
  $ rosservice call /clear
  ```
- シミュレーターの背景色が変わると思います。  

## 5つ目：GUIツールの利用
- rqtはROSのGUIツールです。
- 様々な情報を確認することができますし、値を設定することもできます。
- 例えば、Robot Steeringを用いてトピックを出版することができます。
- まずはrqtを起動します。
  ```
  $ rqt
  ```
- 次に、［Plugins］→［Robot Tools］からでRobot Steeringを追加します。
- /turtle1/cmd_velと入力し、スライダーで値を変化させます。

## 付録
- 下記のようにオプション付きで実行することで、任意の名前でノードを起動することができます。ROSでは、同じ名前のノードは1つしか存在することができないので、同じ名前を指定すると上書きされてしまいます。逆に、異なる名前を指定すれば、複数の亀を発生させることも可能です。1つのキーボードで複数台のロボットを操作できるようになります。
  ```
  $ rosrun turtlesim turtlesim_node __name:=foo
  ```

[このページのトップへ](#)

[応用実験用サイトのトップへ](https://stl-apu.github.io/advanced_experiment_2021/)
